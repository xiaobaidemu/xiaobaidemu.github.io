<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xiaobaidemu.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="数据库死锁问题，是一个老生常谈且很常见的问题，网上也有非常多对于各类死锁场景的解析和复现，但凡和死锁有关，无外乎不涉及数据库隔离等级、索引、以及innodb锁等相关原因。但是我这个案例我搜遍了全网没能找到比较相似情况。于是我想尽可能的复现出这种情况，找出死锁的原因，找出可能出现的隐患。">
<meta property="og:type" content="article">
<meta property="og:title" content="当并发insert on duplicate key update遇见死锁--更新丢失">
<meta property="og:url" content="http://xiaobaidemu.github.io/%E5%BD%93%E5%B9%B6%E5%8F%91insert-on-duplicate-key-update%E9%81%87%E8%A7%81%E6%AD%BB%E9%94%81-%E6%9B%B4%E6%96%B0%E4%B8%A2%E5%A4%B1/index.html">
<meta property="og:site_name" content="xiaobaidemu">
<meta property="og:description" content="数据库死锁问题，是一个老生常谈且很常见的问题，网上也有非常多对于各类死锁场景的解析和复现，但凡和死锁有关，无外乎不涉及数据库隔离等级、索引、以及innodb锁等相关原因。但是我这个案例我搜遍了全网没能找到比较相似情况。于是我想尽可能的复现出这种情况，找出死锁的原因，找出可能出现的隐患。">
<meta property="og:locale">
<meta property="og:image" content="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/e883f65ef1ddb7a5571cadea33bb8a30.png">
<meta property="og:image" content="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/ce9472b9ae1868f4e241e34f98ee1ed2.png">
<meta property="og:image" content="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/c4fde02f099e9c19a8dd9e317c5f24ff.png">
<meta property="og:image" content="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/b1ce2b1cc77b174690791b019438699d.png">
<meta property="og:image" content="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/04ede18d2555a33683012c837ca30bfe.png">
<meta property="og:image" content="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/731d9f06a83d4c729103f65eb3a89966.png">
<meta property="og:image" content="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/b90769bc02aa178901669fa1ad437800.png">
<meta property="article:published_time" content="2020-01-14T16:00:00.000Z">
<meta property="article:modified_time" content="2023-10-19T09:24:56.595Z">
<meta property="article:author" content="xiaobaidemu">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="死锁">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/e883f65ef1ddb7a5571cadea33bb8a30.png">


<link rel="canonical" href="http://xiaobaidemu.github.io/%E5%BD%93%E5%B9%B6%E5%8F%91insert-on-duplicate-key-update%E9%81%87%E8%A7%81%E6%AD%BB%E9%94%81-%E6%9B%B4%E6%96%B0%E4%B8%A2%E5%A4%B1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh","comments":true,"permalink":"http://xiaobaidemu.github.io/%E5%BD%93%E5%B9%B6%E5%8F%91insert-on-duplicate-key-update%E9%81%87%E8%A7%81%E6%AD%BB%E9%94%81-%E6%9B%B4%E6%96%B0%E4%B8%A2%E5%A4%B1/","path":"当并发insert-on-duplicate-key-update遇见死锁-更新丢失/","title":"当并发insert on duplicate key update遇见死锁--更新丢失"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>当并发insert on duplicate key update遇见死锁--更新丢失 | xiaobaidemu</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">xiaobaidemu</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">归档我的五年</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-text">问题的背景：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-text">问题的现象：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-text">相关概念：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-text">问题的复现：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-text">问题的分析：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-text">问题的拓展：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-text">总结：</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">xiaobaidemu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://xiaobaidemu.github.io/%E5%BD%93%E5%B9%B6%E5%8F%91insert-on-duplicate-key-update%E9%81%87%E8%A7%81%E6%AD%BB%E9%94%81-%E6%9B%B4%E6%96%B0%E4%B8%A2%E5%A4%B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaobaidemu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaobaidemu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="当并发insert on duplicate key update遇见死锁--更新丢失 | xiaobaidemu">
      <meta itemprop="description" content="数据库死锁问题，是一个老生常谈且很常见的问题，网上也有非常多对于各类死锁场景的解析和复现，但凡和死锁有关，无外乎不涉及数据库隔离等级、索引、以及innodb锁等相关原因。但是我这个案例我搜遍了全网没能找到比较相似情况。于是我想尽可能的复现出这种情况，找出死锁的原因，找出可能出现的隐患。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          当并发insert on duplicate key update遇见死锁--更新丢失
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-15 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-15T00:00:00+08:00">2020-01-15</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>6.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>22 mins.</span>
    </span>
</div>

            <div class="post-description">数据库死锁问题，是一个老生常谈且很常见的问题，网上也有非常多对于各类死锁场景的解析和复现，但凡和死锁有关，无外乎不涉及数据库隔离等级、索引、以及innodb锁等相关原因。但是我这个案例我搜遍了全网没能找到比较相似情况。于是我想尽可能的复现出这种情况，找出死锁的原因，找出可能出现的隐患。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>数据库死锁问题，是一个老生常谈且很常见的问题，网上也有非常多对于各类死锁场景的解析和复现，但凡和死锁有关，无外乎不涉及数据库隔离等级、索引、以及innodb锁等相关原因。但是我这个案例我<strong>搜遍了全网</strong>也没能找到比较相似情况。于是我想尽可能的复现出这种情况，找出死锁的原因，找出可能出现的隐患。</p>
<h3>问题的背景：</h3>
<p>我们的数据库中的发生死锁的表是具有&rdquo;<em><strong><span style="color: #ff0000;">多列组合构建的唯一索引</span></strong></em>&ldquo;（不包含自增的主键），且数据库的隔离等级为<em><strong><span style="color: #ff0000;">Read Committed</span></strong></em>, 另外对于这个表来说是写入远大于读取的，由于业务的原因，经常会出现<span style="color: #ff0000;">同一数据反复插入</span>（<span style="color: #ff0000;">同一数据指唯一索引值相同的数据，但其他非索引字段可能不同</span>），所以为了简化代码，我们使用insert on duplicate key update来解决这种问题，当mysql检测到唯一键冲突时，仅更新特定（非索引）字段。但是问题就出现在大规模多worker并发插入的时候，会经常出现"<span style="color: #ff0000;">Deadlock found</span> when trying to get lock"。开始真的是百思不得其解，于是乎开始疯狂查阅mysql手册以及各类博文尝试找到问题所在。</p>
<h3>问题的现象：</h3>
<p>一般定位死锁原因第一步就是执行&rdquo;show engine innodb status&ldquo;, 查看innodb Standard monitor输出结果，这里面会有数据库最后一次的死锁记录。会记录出现死锁的两个事务，它们分别在等待什么锁，并且手里持有什么锁。mysql在检测到发生死锁的时候，会随机回滚其中的一个事务，从而解开死锁。下面的截图是发生死锁的时候innodb status截图(和业务相关的数据已脱敏，这里均用column_n和value_n表示)</p>
<p>Transaction1:</p>
<p><img src="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/e883f65ef1ddb7a5571cadea33bb8a30.png" /></p>
<p>Transaction2:</p>
<p><img src="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/ce9472b9ae1868f4e241e34f98ee1ed2.png" /></p>
<p>现象阐述：从上方两个截图可以发现，死锁均发生在insert on duplicate key update语句执行的时候，并且<strong><span style="color: #ff0000;">每个insert语句均为批量插入多个数据</span></strong>。对于事务一，可以看到事务一在<span style="color: #ff0000;">等待某个锁的获取<span style="color: #000000;">，且这个锁是</span></span>"lock_mode X locks gap before rec insert intention waiting"，直接翻译过来就是插入意向锁在等待排他gap锁的释放，也就是只有排他gap锁释放后插入意向锁才能获取到（关于这些锁的含义见下一节）。对于事务二，同样可以看到相同的一句话。并且两个事务的锁冲突均发生在&rdquo;<span style="color: #ff0000;">唯一索引</span>&ldquo;上。再进一步观察可以看到，事务二所持有（"Holds the Locks"下方展示的索引值）的<span style="color: #ff0000;">排它锁所在的索引<span style="color: #000000;">（锁均是加在索引上或者索引区间上的）</span></span>，与事务一<span style="color: #ff0000;">等待获取锁的索引</span>是一样的。进一步展示了的确，在同一个索引上出现了一个等待获取，一个已经获取的冲突现象。</p>
<h3>相关概念：</h3>
<p>在分析问题前，有必要概述一下（详细了解可以见附录），这里面涉及到的锁相关知识。具体可以详见<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html">Mysql手册</a></p>
<p>innodb级锁按照隔离能力，主要分为共享锁（S锁）和排他锁（X锁）。事务T1的某行上持有S锁，则另一事务T2可以在此行获取S锁，但是不能获取此行的X锁，而如果T1在某行上持有X锁，则另一事务T2，对此行既无法获取S锁，也无法获取X锁。（除了S和X锁外，还有表级锁，分别是意向共享IS锁和意向排他IX锁，这里不做深入）。</p>
<p>按照锁的种类：主要有四种。</p>
<p>        1. Record锁：这种锁会在索引上加锁，比如sql为select column_1 from table where column_1=1 for update，且column_1上有索引，则会把colunm_1为1的行都加排它锁，其他事务禁止对此行读和写。</p>
<p>        2. Gap锁（间隙锁）：这种锁作用在索引记录之间。目的只需要记住：他是为<span style="color: #ff0000;">防止其他事务插入间隙</span>（<span style="color: #ff0000;">包括防止insert方式插入新数据到间隙，以及update方式将其他行变更到此间隙</span>）。Gap锁可以有效的防止&rdquo;幻读&ldquo;（因为这些间隙都被上了锁，其他事务不可能再插入数据到这些间隙中，于是当前事务在连续进行&rdquo;当前读&ldquo;时，每次读到的都是相同的记录）。虽然Gap锁只作用在隔离级别为RR及以上的数据库上，但是不意味着隔离等级为RC级别的不会使用，在RC级别，在<span style="color: #ff0000;">进行外键约束检测和唯一键约束检测的时候，会使用到Gap锁</span>，而正是这个duplicate-key checking导致了上文出现的死锁发生。关于Gap锁到底是如何加锁的，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/crazylqy/p/7821481.html">可以参阅这篇文章</a>。</p>
<p><img src="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/c4fde02f099e9c19a8dd9e317c5f24ff.png" /></p>
<p>        3. Next-Key锁：本质上就是Gap锁和Record锁的结合，锁住索引外还要锁住索引的间隙。再具体一些就是，一个record锁，加上，位于此索引记录前的第一个间隙处的间隙锁。举个简单的例子就是，如果现在有一个索引包含三个值1，3，5，则next-key lock锁，可能锁住的范围就有(-&infin;,1],(1,3],(3,5],(5,+&infin;]。同样在next-key lock<strong><em><span style="color: #ff0000;">一般</span></em></strong>作用在RR隔离等级的数据库，但是<span style="color: #ff0000;"><em><strong>当出现在insert时候，检测到唯一键冲突的时候，会在冲突所在唯一索引出和之前的间隙处加Next-key lock.</strong></em></span></p>
<p><img src="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/b1ce2b1cc77b174690791b019438699d.png" /></p>
<p>mysq官方手册中，对Next-key lock在innodb monitor中的打印如下图所示：</p>
<p><img src="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/04ede18d2555a33683012c837ca30bfe.png" /></p>
<p>可以发现和我们在&rdquo;问题的现象&ldquo;一节贴的日志中事务二&rdquo;Hold the Locks&ldquo;处非常相似。所以可以怀疑当时死锁发生的时候，出现了排他的next-key lock。</p>
<p>        4. Insert Intention锁（插入意向锁）：顾名思义，这个锁是在数据插入之前会加此锁。它是一种轻量的Gap锁，同事也是意向排他锁的一种。它的存在使得多个事务在写入不同数据到统一索引间隙的时候，不会发生锁等待。另外由于它是一种意向插入锁，所以<span style="color: #ff0000;">当排他锁已经处于间隙上的时候</span>，根据锁的兼容矩阵，可以知道，<em><strong><span style="color: #ff0000;">意向插入锁必须等待此间隙上的排它锁释放，才能获取。</span></strong></em></p>
<p>根据上面，对锁的种类说明，其实我们已经能猜到，大概是什么锁导致了死锁的出现。（这里我要再明确一点，我们的数据库隔离等级为Read Committed级别。）本质上就是两个事务同时<span style="color: #ff0000;">获取到了不同间隙的X Next-key锁</span>，而<span style="color: #ff0000;">这个两个事务又同时想要向对方已经获取了next-key锁的间隙内插入新的数据<span style="color: #000000;">，</span></span>于是乎死锁出现了。下面我们来完全复现一下。</p>
<h3>问题的复现：</h3>
<p>数据库准备：数据库中能够包含一个unique key： code</p>
<pre class="language-java"><code>CREATE TABLE `test2` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `code` int(11) NOT NULL,
  `other` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB </code></pre>
<p>初始数据：insert into test2 <span class="s1">(</span>code<span class="s1">,</span> other<span class="s1">)</span> values<span class="s1">(</span>1<span class="s1">,</span>1<span class="s1">),(</span>3<span class="s1">,</span>3<span class="s1">),(</span>5<span class="s1">,</span>5<span class="s1">)</span></p>
<p>复现场景：原始的<span class="s1">code字段</span>为<span class="s1">1,3, 5</span>，现在要在中间插入<span class="s1">code</span>为<span class="s1">2</span>，<span class="s1">3</span>，<span class="s1">4</span>，<span class="s1">5</span>的<span class="s1">row</span>, 如果碰到唯一键约束则更新<span class="s1">other</span>字段。</p>
<table style="border-collapse: collapse; width: 0%; height: 481px;" border="1">
<tbody>
<tr style="height: 34px;">
<td style="width: 14.6011%; text-align: center; height: 34px;"><strong>Time</strong></td>
<td style="width: 42.8063%; height: 34px; text-align: center;"><strong>Session1</strong></td>
<td style="width: 42.5926%; height: 34px; text-align: center;"><strong>Session2</strong></td>
</tr>
<tr style="height: 34px;">
<td style="width: 14.6011%; height: 76px; text-align: center;"><strong>T1</strong></td>
<td style="width: 42.8063%; height: 76px; text-align: left;">
<p><strong>start transaction<span class="s1">;</span></strong></p>
<p><strong>insert into </strong>test2<span class="s1">(</span><strong>code</strong><span class="s1">,</span> other<span class="s1">)</span> <strong>values </strong><span class="s1">(</span>3<span class="s1">,</span> 4<span class="s1">)</span> <strong>on duplicate key update </strong>other = <em>VALUES</em><span class="s1">(</span>other<span class="s1">);</span></p>
</td>
<td style="width: 42.5926%; height: 76px; text-align: center;"> </td>
</tr>
<tr style="height: 34px;">
<td style="width: 14.6011%; height: 92px; text-align: center;">T2</td>
<td style="width: 42.8063%; height: 92px;"> </td>
<td style="width: 42.5926%; height: 92px;">
<p class="p1"><strong>start transaction<span class="s1">;</span></strong></p>
<p class="p1"><strong>insert into </strong>test2<span class="s1">(</span><strong>code</strong><span class="s1">,</span> other<span class="s1">)</span> <strong>values </strong><span class="s1">(</span>5<span class="s1">,</span> 6<span class="s1">)</span> <strong>on duplicate key update </strong>other = <em>VALUES</em><span class="s1">(</span>other<span class="s1">);</span></p>
</td>
</tr>
<tr style="height: 34px;">
<td style="width: 14.6011%; height: 129px; text-align: center;">
<p class="p1"><strong>T3</strong></p>
</td>
<td style="width: 42.8063%; height: 129px;">
<p class="p1"><strong>insert into </strong>test2<span class="s1">(</span><strong>code</strong><span class="s1">,</span> other<span class="s1">)</span> <strong>values </strong><span class="s1">(</span>4<span class="s1">,</span> 4<span class="s1">)</span> <strong>on duplicate key update </strong>other = <em>VALUES</em><span class="s1">(</span>other<span class="s1">)</span></p>
<p class="p1"><span style="color: #ff0000;"><em><strong><span class="s1">现象：一直阻塞</span></strong></em></span></p>
</td>
<td style="width: 42.5926%; height: 129px;"> </td>
</tr>
<tr style="height: 150px;">
<td style="width: 14.6011%; height: 150px; text-align: center;">T4</td>
<td style="width: 42.8063%; height: 150px;"> </td>
<td style="width: 42.5926%; height: 150px;">
<p class="p1"><strong>insert into </strong>test2<span class="s1">(</span><strong>code</strong><span class="s1">,</span> other<span class="s1">)</span> <strong>values </strong><span class="s1">(</span>2<span class="s1">,</span> 2<span class="s1">)</span> <strong>on duplicate key update </strong>other = <em>VALUES</em><span class="s1">(</span>other<span class="s1">);</span></p>
<p class="p1"><em><strong><span style="font-size: 14px; color: #ff0000;"><span class="s1">现象：</span>出现死锁，事务回滚 (<span class="s1">2</span>,<span class="s1">2</span>插入失败， 且<span class="s1">code</span>为<span class="s1">5</span>时，更新<span class="s1">other</span>字段失败，更新和插入均丢失)</span></strong></em></p>
</td>
</tr>
</tbody>
</table>
<p>死锁出现后，我们查看innodb status中的死锁记录，如下：</p>
<p class="p1"><img src="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/731d9f06a83d4c729103f65eb3a89966.png" /></p>
<p class="p1">可以发现，复现出来的结果，和上文中的案例几乎完全一致。下面我们对此结果进行分析。</p>
<h3 class="p1">问题的分析：</h3>
<ol>
<li class="p1"><span class="s1"><span class="s1"><span class="s1"><span style="color: #ff0000;">在T1时刻Session1执行完insert操作后<span style="color: #000000;">，由于插入的code=2已经存在于表中，发生了唯一键冲突，所以触发了duplicate-checking，<span style="color: #ff0000;">导致在(1,3]这个区间加上了next-key lock</span>。这里，我为了进一步证明确实只有(1,3]这个区间加了锁。在T1时刻执行完后，验证插入code=0/4/6的数据可以在Session2中执行成功。同时这个时候Session2中可以修改code=1的数据，如update test2 set other=0 where code=1可以执行成功（当然你不能update test2 set code=2 where code=1,因为这个操作是在向(1,3]的间隙内插入了数据，违反了gap锁的要求）。同时我们可以证明这时<span style="color: #ff0000;">code=3肯定是被排他锁锁住</span>的，由于当出现唯一键冲突时，就会执行on duplicate key update，更新other字段，所以code=3一定在更新结束后处于排它锁锁定状态（补充说明：可以证明如果是共享锁的话，session2在T2时刻执行<strong style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">insert into </strong><span style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">test2</span><span class="s1" style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">(</span><strong style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">code</strong><span class="s1" style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';"> other</span><span class="s1" style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">)</span> <strong style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">values </strong><span class="s1" style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">(</span><span style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">3</span><span class="s1" style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';"> 33</span><span class="s1" style="color: #24292e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">)语句的话，一定会立刻包duplicate error而不会阻塞。但是事实上如果Session2在T2时刻执行这句sql，会一直阻塞，进一步说明code=3加的是排它锁。另外需要注意的是，其实我目前只能非常确定<span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">code = 3</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">是有排它锁，但是(</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">1</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">3</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">)上面，到底是</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">S gap lock </span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">还是</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">X gap lock</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">无法确定，不过无论是S还是X,不影响后续的解释。</span></span></span></span></span></span></span><span class="s1"><span style="color: #ff0000;"><span style="color: #000000;">）</span></span></span></li>
<li class="p1">
<p class="p1"><span class="s1">在</span>T2 <span class="s1">完成时，同理也会在<span style="color: #ff0000;">（</span></span><span style="color: #ff0000;">3<span class="s1">，</span>5<span class="s1">]这个区间上</span>X next-key lock</span> <span class="s1">(在上面的截图中也可以看到插入</span>code=5<span class="s1">后，正在插入</span>code=2<span class="s1">的时候，写着</span>HOLD the lock hex 80000005<span class="s1">)</span></p>
</li>
<li class="p1">
<p class="p1">当<span class="s1">T1和T2</span>执行完成之后，我们可以看到(<span class="s1">1</span>,<span class="s1">3</span>] 和（<span class="s1">3</span>,<span class="s1">5</span>]分别被<span class="s1">Session1</span>和<span class="s1">Session2</span>锁定，<span class="s1">T3</span>时候，<span style="color: #ff0000;"><span class="s1">Session1</span>尝试插入<span class="s1">code=4</span>, 由于在插入前会加插入意向锁</span>，（对于插入意向锁的锁的范围，我目前尚无法确认在3~5的区间内加锁的时候，左右临界的开合问题）但是很明显，插入意向锁一定和(<span class="s1"><strong>3</strong></span>,<span class="s1"><strong>5</strong></span>]区间的<span class="s1"><strong>next-key lock</strong></span>有重合，所以会出现在Session1执行<span class="s1"><strong>T3</strong></span>的时候，语句被阻塞了，它在等待<span class="s1"><strong>Session2</strong></span>释放(<span class="s1"><strong>3</strong></span>,<span class="s1"><strong>5</strong></span>]这个区间的X<span class="s1"><strong> next_key</strong> lock 。可以参考下图&mdash;&mdash;一个非常详细的锁兼容矩阵，理解阻塞原因（<a target="_blank" rel="noopener" href="https://my.oschina.net/actiontechoss/blog/3068976">兼容矩阵图链接</a></span><span class="s1">）。</span><span class="s1"><img src="https://ata2-img.cn-hangzhou.oss-pub.aliyun-inc.com/b90769bc02aa178901669fa1ad437800.png" /></span></p>
</li>
<li class="p1">
<p class="p1">同理，在<span class="s1">T4时刻Session2执行插入语句</span>的时候，由于（<span class="s1">1</span>,<span class="s1">3</span>]被阻塞了，但是插入的时候又要请求<span class="s1">1~3</span>这个区间的插入意向锁，等待<span class="s1">Session1</span>释放X<span class="s1"> next-key lock</span>。于是乎死锁发生，Session2被回滚。</p>
</li>
</ol>
<p class="p1">至此：死锁的现象可以顺利的解释通。（当然，这里还有一个疑惑不是很明白，当出现唯一冲突的时候为什么要加Next-Key Lock。有知道原因的小伙伴可以告诉我）</p>
<h3>问题的拓展：</h3>
<ol>
<li>如果将insert on duplicate key update换成insert ignore语句，是否可以避免死锁的发生呢？答案是：否定的。其实原理都是一样的。如果我们将上述复现中的insert on duplicate key update换成insert ignore，同样会在T4时刻出现死锁。</li>
<li>同样，update和insert on duplicate key update组合也可以构造出死锁的出现。数据库中表结构不变，数据初始化为(<span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">1</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">1</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">1</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">),(</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">3</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">3</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">3</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">),(</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">5</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">5</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">5</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">)</span> <span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">分别对应</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">id</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';"> code</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">other</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">,</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';"> id</span><span class="s1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">是</span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">pk.</span></li>
</ol>
<table style="border-collapse: collapse; width: 0%; height: 481px;" border="1">
<tbody>
<tr style="height: 34px;">
<td style="width: 14.6011%; text-align: center; height: 34px;"><strong>Time</strong></td>
<td style="width: 42.8063%; height: 34px; text-align: center;"><strong>Session1</strong></td>
<td style="width: 42.5926%; height: 34px; text-align: center;"><strong>Session2</strong></td>
</tr>
<tr style="height: 34px;">
<td style="width: 14.6011%; height: 76px; text-align: center;"><strong>T1</strong></td>
<td style="width: 42.8063%; height: 76px; text-align: left;">
<p><strong>start transaction<span class="s1">;</span></strong></p>
<p class="p1"><strong>update </strong>test2 <strong>set </strong>other=1 <strong>where </strong>id=3<span class="s1">;</span></p>
</td>
<td style="width: 42.5926%; height: 76px; text-align: center;"> </td>
</tr>
<tr style="height: 34px;">
<td style="width: 14.6011%; height: 92px; text-align: center;">T2</td>
<td style="width: 42.8063%; height: 92px;"> </td>
<td style="width: 42.5926%; height: 92px;">
<p class="p1"><strong>start transaction<span class="s1">;</span></strong></p>
<p class="p1"><strong>insert into </strong>test2<span class="s1">(</span><strong>code</strong><span class="s1">,</span> other<span class="s1">)</span> <strong>values </strong><span class="s1">(</span>5<span class="s1">,</span> 55<span class="s1">)</span> <strong>on duplicate key update </strong>other = <em>VALUES</em><span class="s1">(</span>other<span class="s1">);</span></p>
</td>
</tr>
<tr style="height: 34px;">
<td style="width: 14.6011%; height: 129px; text-align: center;">
<p class="p1"><strong>T3</strong></p>
</td>
<td style="width: 42.8063%; height: 129px;">
<p class="p1"><strong>update </strong>test2 <strong>set </strong>other=1 <strong>where </strong>id=5<span class="s1">;</span></p>
<p class="p1"><em><strong><span class="s1" style="color: #ff0000;">现象：一直阻塞</span></strong></em></p>
</td>
<td style="width: 42.5926%; height: 129px;"> </td>
</tr>
<tr style="height: 150px;">
<td style="width: 14.6011%; height: 150px; text-align: center;">T4</td>
<td style="width: 42.8063%; height: 150px;"> </td>
<td style="width: 42.5926%; height: 150px;">
<p class="p1"><strong>insert into </strong>test2<span class="s1">(</span><strong>code</strong><span class="s1">,</span> other<span class="s1">)</span> <strong>values </strong><span class="s1">(</span>3<span class="s1">,</span> 33<span class="s1">)</span> <strong>on duplicate key update </strong>other = <em>VALUES</em><span class="s1">(</span>other<span class="s1">);</span></p>
<p class="p1"><em><strong><span style="color: #ff0000;">现象：出现死锁，回滚 (<span class="s1">2</span>,<span class="s1">2</span>插入失败)</span></strong></em></p>
</td>
</tr>
</tbody>
</table>
<h3>总结：</h3>
<p>    说了这么多，死锁的原因找到了，解决的办法其实比较简单。</p>
<ol>
<li>将批量insert on duplicate key update,拆分成多个语句。保证<span style="color: #ff0000;">一次事务中</span>不要插入过多值，将多个数据，变成多个sql，执行插入。可以有效的减少死锁命中的发生。</li>
<li>重试：死锁不可怕，当出现死锁发生时，多执行重试操作可以有效保证插入成功，更新不丢失。</li>
</ol>
<p>参考文章：</p>
<ol>
<li><span style="font-size: 10px;"><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-insert-intention-locks">https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-insert-intention-locks</a></span></li>
<li><span style="font-size: 10px;"><a target="_blank" rel="noopener" href="https://dba.stackexchange.com/questions/237549/gap-locking-in-read-committed-isolation-level-in-mysql">https://dba.stackexchange.com/questions/237549/gap-locking-in-read-committed-isolation-level-in-mysql</a></span></li>
<li><span style="font-size: 10px;"><a target="_blank" rel="noopener" href="https://www.cnblogs.com/crazylqy/p/7773492.html">https://www.cnblogs.com/crazylqy/p/7773492.html</a></span></li>
<li><span style="font-size: 10px;"><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/dca007208a58">https://www.jianshu.com/p/dca007208a58</a></span></li>
<li><span style="font-size: 10px;"><a target="_blank" rel="noopener" href="https://my.oschina.net/actiontechoss/blog/3068976">https://my.oschina.net/actiontechoss/blog/3068976</a></span></li>
<li><span style="font-size: 10px;"><a target="_blank" rel="noopener" href="https://www.aneasystone.com/archives/2017/12/solving-dead-locks-three.html">https://www.aneasystone.com/archives/2017/12/solving-dead-locks-three.html</a></span></li>
<li><span style="font-size: 10px;"><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhoujinyi/p/3435982.html">https://www.cnblogs.com/zhoujinyi/p/3435982.html</a></span></li>
<li><span style="font-size: 10px;">http://thushw.blogspot.com/2010/11/mysql-deadlocks-with-concurrent-inserts.html</span></li>
</ol>
<p> </p>
<p> </p>
<p> </p>
<p> </p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># 数据库</a>
              <a href="/tags/%E6%AD%BB%E9%94%81/" rel="tag"># 死锁</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8redis%E8%AE%A9%E5%91%A8%E6%9C%9F%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E5%8F%98%E5%BE%97fault-tolerant%E4%B8%94dynamic/" rel="prev" title="如何使用Redis让周期异步任务变得Fault-tolerant且Dynamic">
                  <i class="fa fa-angle-left"></i> 如何使用Redis让周期异步任务变得Fault-tolerant且Dynamic
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E8%BF%99%E4%B8%AA%E6%83%85%E4%BA%BA%E8%8A%82%EF%BC%8C%E5%9C%A8%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E8%AF%95%E7%9D%80%E8%A1%A8%E8%BE%BE%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E7%88%B1%E6%84%8F/" rel="next" title="这个情人节，在云服务器上试着表达不一样的爱意">
                  这个情人节，在云服务器上试着表达不一样的爱意 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">xiaobaidemu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">45k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">2:44</span>
  </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
